#!/usr/bin/env bash
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Paths - resolve symlinks to get the real script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
SCAFFOLDS_DIR="$(dirname "$SCRIPT_DIR")/scaffolds"
PROJECT_DIR="${HOME}/code"

# Helper functions
print_header() {
    echo -e "\n${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${CYAN}  $1${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"
}

print_step() {
    echo -e "${GREEN}→${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

# Prompt for input with default
prompt() {
    local prompt_text="$1"
    local default="$2"
    local result

    if [ -n "$default" ]; then
        read -p "$prompt_text [$default]: " result
        echo "${result:-$default}"
    else
        read -p "$prompt_text: " result
        echo "$result"
    fi
}

# Prompt for yes/no
confirm() {
    local prompt_text="$1"
    local default="${2:-y}"
    local result

    if [ "$default" = "y" ]; then
        read -p "$prompt_text [Y/n]: " result
        result="${result:-y}"
    else
        read -p "$prompt_text [y/N]: " result
        result="${result:-n}"
    fi

    [[ "$result" =~ ^[Yy] ]]
}

# Select from options
select_option() {
    local prompt_text="$1"
    shift
    local options=("$@")

    echo -e "\n${BLUE}$prompt_text${NC}"
    for i in "${!options[@]}"; do
        echo "  $((i+1))) ${options[$i]}"
    done

    local selection
    while true; do
        read -p "Select [1-${#options[@]}]: " selection
        if [[ "$selection" =~ ^[0-9]+$ ]] && [ "$selection" -ge 1 ] && [ "$selection" -le "${#options[@]}" ]; then
            echo "${options[$((selection-1))]}"
            return
        fi
        echo "Invalid selection"
    done
}

# Check for existing project
check_existing_project() {
    local project_path="$1"

    if [ -d "$project_path" ]; then
        if [ -f "$project_path/.claude/CLAUDE.md" ]; then
            # Check if it's a discovery project
            if grep -q "Discovery Phase" "$project_path/.claude/CLAUDE.md" 2>/dev/null; then
                return 1  # Discovery project exists
            fi
        fi
        return 2  # Non-discovery project exists
    fi
    return 0  # No project
}

# Scaffold T3 project
scaffold_t3() {
    local project_name="$1"
    local project_path="$PROJECT_DIR/$project_name"

    print_step "Creating T3 project with create-t3-app..."

    cd "$PROJECT_DIR"
    npx create-t3-app@latest "$project_name" \
        --CI \
        --noGit \
        --appRouter \
        --tailwind \
        --trpc \
        --prisma \
        --nextAuth \
        --dbProvider postgresql

    cd "$project_path"

    # Install UI kit packages
    print_step "Installing UI kit packages..."
    npm install lucide-react class-variance-authority clsx tailwind-merge sonner next-themes @radix-ui/react-slot @radix-ui/react-tooltip

    # Install testing packages
    print_step "Installing testing packages..."
    npm install -D vitest @vitest/ui @testing-library/react @testing-library/jest-dom @playwright/test husky lint-staged oxlint

    # Copy Claude setup
    print_step "Setting up Claude Code..."
    mkdir -p .claude/commands
    cp "$SCAFFOLDS_DIR/t3/CLAUDE.md" ./CLAUDE.md
    sed -i '' "s/{{PROJECT_NAME}}/$project_name/g" ./CLAUDE.md
    cp "$SCAFFOLDS_DIR/t3/settings.json" .claude/settings.json
    cp "$SCAFFOLDS_DIR/t3/mcp.json" .claude/mcp.json
    cp "$SCAFFOLDS_DIR/t3/claudeignore" .claudeignore

    # Copy devops
    print_step "Setting up DevOps..."
    mkdir -p .github/workflows
    cp "$SCAFFOLDS_DIR/t3/devops/coderabbit.yaml" .coderabbit.yaml
    cp "$SCAFFOLDS_DIR/t3/devops/vercel.json" ./vercel.json
    cp "$SCAFFOLDS_DIR/t3/devops/workflows/"*.yml .github/workflows/
    cp "$SCAFFOLDS_DIR/t3/devops/PULL_REQUEST_TEMPLATE.md" .github/

    # Initialize husky
    print_step "Setting up git hooks..."
    npx husky init
    echo 'npx lint-staged' > .husky/pre-commit

    print_success "T3 project created!"
}

# Scaffold Laravel project
scaffold_laravel() {
    local project_name="$1"
    local project_path="$PROJECT_DIR/$project_name"

    print_step "Creating Laravel project..."

    cd "$PROJECT_DIR"
    composer create-project laravel/laravel "$project_name"

    cd "$project_path"

    # Install Breeze with React + Inertia
    print_step "Installing Laravel Breeze with React..."
    composer require laravel/breeze --dev
    php artisan breeze:install react --typescript --ssr

    # Install UI kit packages (npm)
    print_step "Installing UI kit packages..."
    npm install lucide-react class-variance-authority clsx tailwind-merge sonner

    # Install testing packages
    print_step "Installing testing packages..."
    composer require pestphp/pest pestphp/pest-plugin-laravel --dev
    composer require laravel/dusk --dev
    composer require larastan/larastan --dev

    # Copy Claude setup
    print_step "Setting up Claude Code..."
    mkdir -p .claude/commands
    cp "$SCAFFOLDS_DIR/laravel/CLAUDE.md" ./CLAUDE.md
    sed -i '' "s/{{PROJECT_NAME}}/$project_name/g" ./CLAUDE.md
    cp "$SCAFFOLDS_DIR/laravel/settings.json" .claude/settings.json
    cp "$SCAFFOLDS_DIR/laravel/mcp.json" .claude/mcp.json
    cp "$SCAFFOLDS_DIR/laravel/claudeignore" .claudeignore

    # Copy devops
    print_step "Setting up DevOps..."
    mkdir -p .github/workflows
    cp "$SCAFFOLDS_DIR/laravel/devops/coderabbit.yaml" .coderabbit.yaml
    cp "$SCAFFOLDS_DIR/laravel/devops/workflows/"*.yml .github/workflows/
    cp "$SCAFFOLDS_DIR/laravel/devops/PULL_REQUEST_TEMPLATE.md" .github/

    print_success "Laravel project created!"
}

# Scaffold Discovery project
scaffold_discovery() {
    local project_name="$1"
    local project_path="$PROJECT_DIR/$project_name"

    print_step "Creating Discovery project..."

    mkdir -p "$project_path/.claude/commands"
    mkdir -p "$project_path/requirements"

    # Copy Claude setup
    cp "$SCAFFOLDS_DIR/discovery/CLAUDE.md" "$project_path/.claude/CLAUDE.md"
    sed -i '' "s/{{PROJECT_NAME}}/$project_name/g" "$project_path/.claude/CLAUDE.md"

    # Also create a symlink at the root for convenience
    ln -sf .claude/CLAUDE.md "$project_path/CLAUDE.md"

    # Copy requirements commands
    cp "$SCAFFOLDS_DIR/discovery/commands/"*.md "$project_path/.claude/commands/"

    # Create .gitkeep
    touch "$project_path/requirements/.current-requirement"

    print_success "Discovery project created!"
}

# Upgrade discovery project to a stack
upgrade_project() {
    local project_name="$1"
    local project_path="$PROJECT_DIR/$project_name"

    if [ ! -d "$project_path" ]; then
        print_error "Project $project_name does not exist"
        exit 1
    fi

    if ! grep -q "Discovery Phase" "$project_path/.claude/CLAUDE.md" 2>/dev/null; then
        print_error "$project_name is not a Discovery project"
        exit 1
    fi

    print_header "Upgrading $project_name"

    local stack
    stack=$(select_option "Select stack:" "T3 (Next.js)" "Laravel")

    # Backup requirements
    print_step "Preserving requirements folder..."
    local temp_requirements="/tmp/requirements-backup-$$"
    if [ -d "$project_path/requirements" ]; then
        cp -r "$project_path/requirements" "$temp_requirements"
    fi

    # Remove old project (except requirements)
    rm -rf "$project_path"

    # Create new project
    case "$stack" in
        "T3 (Next.js)")
            scaffold_t3 "$project_name"
            ;;
        "Laravel")
            scaffold_laravel "$project_name"
            ;;
    esac

    # Restore requirements
    if [ -d "$temp_requirements" ]; then
        print_step "Restoring requirements folder..."
        cp -r "$temp_requirements" "$project_path/requirements"
        rm -rf "$temp_requirements"
    fi

    print_success "Project upgraded!"
}

# Initialize git and optionally create GitHub repo
init_git() {
    local project_name="$1"
    local project_path="$PROJECT_DIR/$project_name"

    cd "$project_path"

    if [ ! -d .git ]; then
        print_step "Initializing git repository..."
        git init
        git add .
        git commit -m "feat: initial scaffold

Created with create-project scaffold tool"
    fi

    if confirm "Create private GitHub repository?"; then
        print_step "Creating GitHub repository..."
        gh repo create "$project_name" --private --source=. --push
        print_success "GitHub repository created: https://github.com/$(gh api user -q .login)/$project_name"
    fi
}

# Main function
main() {
    print_header "Create Project"

    local project_name=""
    local project_type=""
    local upgrade_mode=false

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --type=*)
                project_type="${1#*=}"
                shift
                ;;
            --upgrade)
                upgrade_mode=true
                shift
                ;;
            -*)
                print_error "Unknown option: $1"
                exit 1
                ;;
            *)
                project_name="$1"
                shift
                ;;
        esac
    done

    # Get project name if not provided
    if [ -z "$project_name" ]; then
        project_name=$(prompt "Project name")
    fi

    # Validate project name
    if [ -z "$project_name" ]; then
        print_error "Project name is required"
        exit 1
    fi

    local project_path="$PROJECT_DIR/$project_name"

    # Handle upgrade mode
    if $upgrade_mode; then
        upgrade_project "$project_name"
        init_git "$project_name"
        echo -e "\n${GREEN}Done!${NC} cd ~/code/$project_name"
        exit 0
    fi

    # Check for existing project
    check_existing_project "$project_path"
    local existing_status=$?

    if [ $existing_status -eq 1 ]; then
        if confirm "Discovery project exists. Upgrade to a stack?"; then
            upgrade_project "$project_name"
            init_git "$project_name"
            echo -e "\n${GREEN}Done!${NC} cd ~/code/$project_name"
            exit 0
        else
            print_error "Project already exists"
            exit 1
        fi
    elif [ $existing_status -eq 2 ]; then
        print_error "Project $project_name already exists and is not a Discovery project"
        exit 1
    fi

    # Get project type if not provided
    if [ -z "$project_type" ]; then
        project_type=$(select_option "Select project type:" "T3 (Next.js)" "Laravel" "Discovery")
    fi

    # Scaffold based on type
    case "$project_type" in
        t3|"T3"|"T3 (Next.js)")
            scaffold_t3 "$project_name"
            ;;
        laravel|"Laravel")
            scaffold_laravel "$project_name"
            ;;
        discovery|"Discovery")
            scaffold_discovery "$project_name"
            ;;
        *)
            print_error "Unknown project type: $project_type"
            exit 1
            ;;
    esac

    # Git setup
    init_git "$project_name"

    echo -e "\n${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}  Project created successfully!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "\n  ${CYAN}cd ~/code/$project_name${NC}\n"
}

main "$@"
